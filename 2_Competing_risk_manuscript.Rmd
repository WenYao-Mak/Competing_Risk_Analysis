---
title: 'Risk of peritonitis in Malaysian incident PD patients: a competing risks approach'
author: "Mak Wen Yao, Ong Loke Meng"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  bookdown::word_document2
fontsize: 12pt
header-includes:
- \usepackage{booktabs}
- \usepackage{longtable}
- \usepackage{array}
- \usepackage{multirow}
- \usepackage{xcolor}
- \usepackage{wrapfig}
- \usepackage{float}
- \usepackage{colortbl}
- \usepackage{pdflscape}
- \usepackage{tabu}
- \usepackage{threeparttable}
- \usepackage[normalem]{ulem}
mainfont: Arial
classoption: a4paper
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r ff_final, eval=T, echo=F, cache=F, results=F, warning=F, message=F}

# Recode the variable 
library(finalfit)
library(survival)
library(survminer)
library(dplyr)
library(forcats) #solve problems with factor variables 
library(kableExtra)

#for the vignette, pre-specify table output (can be modified for poster)
mykable = function(x){
  knitr::kable(x, row.names = FALSE, align = c("l","l","r","r","r","r","r","r","r")) %>%
    kable_styling(font_size=35)
}


#data use here is "comp" 
  #status == 0, no outcome 
  #status == 1, peritonitis 
  #status == 2, transfer to HD as competing risk 
  #variables included: PtRace,PtSex, PtAssist, dm, gl,uro, neph,hpt, AD, her.neph, Age2 brand, site, month_diag, month_pd

comp = comp %>% 
  mutate(
    #overall survival 
    status_os = ifelse(status == 1, 1, #peritonitis
                                      0), #no peritonitis 
    
    #disease specific survival 
    status_dss = case_when(
      status == 0 ~ 0, #no event  
      status == 1 ~ 1, #peritonitis 
      TRUE ~ 0),    #Other causes are censored 
    
    #disease specific survival on technique failure 
    status_dss2 = case_when(
      status == 0 ~ 0, #no event 
      status == 2 ~ 1, #technique failure 
      TRUE ~ 0),       #other causes are censored
    
    #competing risk regression 
    status_crr = case_when(
      status == 0 ~ 0, #no event 
      status == 1 ~ 1, #peritonitis 
      status == 2 ~ 2, #competing risk 
      TRUE ~ 0), 
    
    #competing risk regression on technique failure 
    status_crr2 = case_when(
      status == 0 ~ 0, #no event 
      status == 2 ~ 1, #technique failure 
      status == 1 ~ 2, #competing risk 
      TRUE ~ 0),
    
    #Label and recode other variable 
    Age2 = factor(Age2) %>%
      fct_recode("18-29" = "18-29", 
                 "30-39" = "30-39",
                 "40-49" = "40-49",
                 "50-59" = "50-59",
                 "60-69" = "60-69") %>%
      ff_label("Age Group"),
    PtRace = factor(PtRace) %>%
      fct_recode("Malay" = "1", 
                 "Chinese" = "2",
                 "Indian" = "3", 
                 "Bumi Sabah" = "5", 
                 "Bumi Sarawak" = "6", 
                 "Other Msian" = "19") %>%
      ff_label("Race"), 
    PtAssist = factor(PtAssist) %>%
      fct_recode("No help" = "1", 
                 "Partial" = "2", 
                 "Dependent" = "3") %>%
      ff_label("PD Assistance"), 
    dm = factor(dm) %>%
      fct_recode("Yes" = "1", 
                 "No" = "0") %>%
      ff_label("Diabetes"), 
    gl = factor(gl) %>%
      fct_recode("Yes" = "1", 
                 "No" = "0") %>%
      ff_label("Glomerulonephritis"), 
    uro = factor(uro) %>%
      fct_recode("Yes" = "1", 
                 "No" = "0") %>%
      ff_label("Obstructive uropathy"), 
    neph = factor(neph) %>%
      fct_recode("Yes" = "1", 
                 "No" = "0") %>%
      ff_label("Drugs/toxic nephropathy"), 
    hpt = factor(hpt) %>%
      fct_recode("Yes" = "1", 
                 "No" = "0") %>%
      ff_label("Hypertension"), 
    AD = factor(AD) %>%
      fct_recode("Yes" = "1", 
                 "No" = "0") %>%
      ff_label("ADPKD"), 
    her.neph = factor(her.neph) %>%
      fct_recode("Yes" = "1", 
                 "No" = "0") %>%
      ff_label("Hereditary nephritis"), 
    brand = factor(brand) %>%
      fct_recode("Baxter" = "1", 
                 "Fresenius" = "2", 
                 "Lucenxia" = "3") %>%
      ff_label("PD Company"), 
    site = factor(site) %>%
      fct_recode("Kedah" = "2", 
                 "Penang" = "3",
                 "Perak" = "4", 
                 "N.Sembilan" = "5", 
                 "Selangor" = "6", 
                 "Melaka" = "7", 
                 "Johor" = "8", 
                 "Kelantan" = "9", 
                 "Terengganu" = "10", 
                 "Pahang" = "11", 
                 "Sabah" = "12", 
                 "Sarawak" = "13", 
                 "KL" = "14") %>%
      ff_label("States"),
    PDSystem = factor(PDSystem) %>%
      fct_recode("Ultrabag"            = "101", 
                 "Icodextrin"          = "102", 
                 "HomeChoice/Pro"      = "105",
                 "Baxter (unknown)"    = "188", 
                 "Andy Disc"           = "201", 
                 "Stay Safe"           = "202", 
                 "Balance"             = "204",
                 "Sleep Safe"          = "206", 
                 "Fresenius (unknown)" = "288", 
                 "Intellis"            = "301") %>%
      ff_label("PD brands")
    )

#relocate the status columns 
comp = comp %>%
  relocate(status_os, .after=status) %>%
  relocate(status_dss, .after=status_os) %>%
  relocate(status_dss2, .after=status_dss) %>%
  relocate(status_crr, .after=status_dss2) %>%
  relocate(status_crr2, .after=status_crr)


#############################################################################################
############################# KM ANALYSIS FOR THE WHOLE COHORT ##############################
#############################################################################################

# to plot survival stratified by a single grouping variable, substitute "survival_object~1" by "survival_object~factor" 

survival_object = comp %$%        #beware of the exposition parameter, and NOT %>%
  Surv(time = m.time, status_os)
 
# Overall survival in whole cohort 
 my_survfit = survfit(survival_object ~ 1, data = comp)
 my_survfit  #1149 patients, 418 events 

# Life table 
## A tabular form of KM plot that shows survival as a proportion, together with confidence limits 
summary(my_survfit, times = c(0, 12, 24, 36, 48, 60))

# Kaplan Meier Plot 
dependent_os = "Surv(time/30, status_os)"
explanatory = 1

 comp %>%
   surv_plot(dependent_os, explanatory, pval=TRUE)

# Total number of censor 
 sum(comp$status==0) #574
 sum(comp$status==2)
 
#############################################################################################
############################# CAUSE-SPECIFIC HAZARD REGRESSION ##############################
#############################################################################################

# COX PROPORTIONAL HAZARD REGRESSION 

# STEP 1: Univariable and multivariable models 
dependent_os = "Surv(m.time, status_os)"
dependent_dss = "Surv(m.time, status_dss)"
dependent_dss2 = "Surv(m.time, status_dss2)"
dependent_crr = "Surv(m.time, status_crr)"
dependent_crr2 = "Surv(m.time, status_crr2)"

explanatory = c("PtRace", "Age2", "PtAssist", "dm", "gl","neph","hpt","AD","her.neph", "site", "brand")

comp %>% 
  finalfit(dependent_os, explanatory) # %>%
  # mykable() #for vignette only 

#the labelling of the final table can be easily adjusted as desired 
comp %>%
  finalfit(dependent_os, explanatory, add_dependent_label = FALSE) %>%
  rename("Overall survival" = label) %>%
  rename(" " = levels) %>%
  rename("  " = all) %>%
  mykable()

# STEP 2: Reduced model 
#if you are using a backwards selection approach or similar, a reduced model can be directly specified and compared. The full model can be kept or dropped 
## variables that are significant at p<0.1 in the Cox univriable

explanatory_multi = c("PtRace", "Age2", "PtAssist", "dm", "brand", "site")

comp %>%
  finalfit(dependent_os, explanatory, explanatory_multi, keep_models = TRUE) %>%
  mykable()

###############
###############
## cox.zph() ##  Testing PH Assumption in CSH of covariates 
###############
###############

#the cox.zph() function from the survival package allows us to test this assumption for each variable. The plot of scaled Schoenfeld residuals should be a horizontl line. The included hypothesis test identifies whether the gradient differs from zero for each variables. No variable significantly differs from zero at the 5% significance level 

## Event of Interest: Peritonitis 

explanatory = c("PtRace","Age2", "PtAssist", "dm", "brand", "strata(site)")  # categorical "Age2" was used 

 comp %>% 
   coxphmulti(dependent_dss, explanatory) %>%
   cox.zph() %>%
   {zph_result <<- .} %>%
   plot() %>% #change the var=*number* to change which covariate is plotted 
              #leaving the `var=1` empty, i.e. plot(), will plot all covariates 
   abline(h=0, lty=3) #only applies to the last plot (why?)

 zph_result

 
 ## Event of Interst: Technique Failure 
 
 explanatory = c("PtRace","Age2", "PtAssist", "dm", "brand", "strata(site)")  # categorical "Age2" was used 

 comp %>% 
   coxphmulti(dependent_dss2, explanatory) %>%
   cox.zph() %>%
   {zph_result <<- .} %>%
   plot() %>% #change the var=*number* to change which covariate is plotted 
              #leaving the `var=1` empty, i.e. plot(), will plot all covariates 
   abline(h=0, lty=3) #only applies to the last plot (why?)

 zph_result
 
 
 
 
 
 
 
 
 

# STEP 3: Stratified models based on "state"
# including a strata() term will result in a separate baseline hazard function being fit for each level in the stratification variable. It will no longer be possible to make direct inference on the effect associated with that variable 

explanatory = c("PtRace", "Age2", "PtAssist", "dm", "brand", "strata(site)") #stratified according to state of the sites

comp %>% 
  finalfit(dependent_dss, explanatory) %>%
  mykable()


# STEP 4: Correlated Groups of Observations 
# to account for any higher structure in the data, e.g. patients are clustered within particular hospitals 
# Two broad approach to dealing with correlated groups of observatio n

# cluster() term: implies a generalised estimating equation (GEE) approach. A standard Cox PH model is fitted but the standard errors of the estimated hazard ratios are adjusted to account for correlations 

# frailty() term: implies a mixed effect model, where specific random effects term(s) are directly incorporated into the model 

# Both approaches achieve the same goal in different ways. the latter approach is favoured because of its flexibility and own preference. Note: cluster() and frailty() cannot be combined in the same model 

#Cluster model 
#explanatory = c("PtRace", "Age2", "PtAssist", "brand", "dm", "cluster(site)")
#comp %>% 
#  finalfit(dependent_os, explanatory) %>%
#  mykable()


#frailty model 
explanatory = c("PtRace", "Age", "PtAssist", "brand", "dm", "frailty(site)")

comp %>% 
  finalfit(dependent_dss, explanatory) %>%
  mykable()


# STEP 4: frailty model on technique failure 
explanatory = c("PtRace", "Age", "PtAssist", "brand", "dm", "frailty(site)")

comp %>% 
  finalfit(dependent_dss2, explanatory) %>%
  mykable()


#Hazard ratio plot 
  comp %>% 
    hr_plot(dependent_os, explanatory)

#############################################################################################
########################### SUBDISTRIBUTION HAZARD REGRESSION ###############################
#############################################################################################

#COMPETING RISK REGRESSION 

#the Fine & Gray model is one option to deal with competing risk. The crr() syntax differs from survival::coxph() but finalfit brings these together 

#it uses the finalfit::ff_merge() function, which can join any number of models together 
 
explanatory = c("PtRace", "Age2", "PtAssist", "dm", "brand", "site")
dependent_dss = "Surv(m.time, status_dss)"
dependent_dss2 = "Surv(m.time, status_dss2)"
dependent_crr = "Surv(m.time, status_crr)"

  comp %>% 
    #summary table 
  summary_factorlist(dependent_dss, explanatory, column = TRUE, fit_id = TRUE) %>% 
  
    #Cox PH univariable 
      ff_merge(
        comp %>% 
          coxphuni(dependent_dss, explanatory) %>%
          fit2df(estimate_suffix = " (DSS CPH univariable)")
      ) %>%
    #Cox PH multivariable 
      ff_merge(
        comp %>% 
          coxphmulti(dependent_dss, explanatory) %>%
          fit2df(estimate_suffix = " (DSS CPH multivariable)")
      ) %>%
  
    #Fine & Gray Competing Risk model 
      ff_merge(
        comp %>% 
          crrmulti(dependent_crr, explanatory) %>% 
          fit2df(estimate_suffix = " (competing risks multivariable")
      ) %>% 
  
  select(-fit_id, -index) %>% 
  dependent_label(comp, "Survival") %>%
    mykable()


###############
###############
##   crr()   ##  Testing PH Assumption in SH of covariates 
###############
###############

explanatory = c("PtRace", "Age2", "PtAssist", "dm", "brand", "site")
dependent_dss = "Surv(m.time, status_dss)"
dependent_dss2 = "Surv(m.time, status_dss2)"
dependent_crr = "Surv(m.time, status_crr)"
  
  
### Only CPH and competing risk   
explanatory = c("Age2","PtAssist", "brand", "site")
dependent_dss = "Surv(m.time, status_dss)"
dependent_crr = "Surv(m.time, status_crr)"

tab1 <- comp %>% 
    #summary table 
  summary_factorlist(dependent_dss, explanatory, column = TRUE, fit_id = TRUE) %>% 
  
    #Cox PH multivariable 
      ff_merge(
        comp %>% 
          coxphmulti(dependent_dss, explanatory) %>%
          fit2df(estimate_suffix = " (DSS CPH multivariable)")
      ) %>%
  
    #Fine & Gray Competing Risk model 
      ff_merge(
        comp %>% 
          crrmulti(dependent_crr, explanatory) %>% 
          fit2df(estimate_suffix = " (competing risks multivariable")
      ) %>% 
  
  select(-fit_id, -index) %>% 
  dependent_label(comp, "Survival") %>%
    mykable()

# guide form Emily Zabor: https://www.emilyzabor.com/tutorials/survival_analysis_in_r_tutorial.html#Part_3:_Competing_Risks 
# Cumulative incidence in peritonitis data 
library(cmprsk)

cuminc(comp$m.time, comp$status, cencode = 2)


# Plot the cumulative incidence in base R 

ci_fit <- 
  cuminc(
    ftime = comp$m.time,
    fstatus = comp$status,
    cencode = 0  #what is cencode really? 
  )

plot(ci_fit)

# plot from ggcompetingrisks 
library(survminer)
ggcompetingrisks(ci_fit)

# compare CI between groups 

ci_brand <- 
  cuminc(
    ftime = comp$m.time,
    fstatus = comp$status,
    group = comp$brand,
    cencode = 0  #what is cencode really? 
  )

ci_brand[["Tests"]]

# plot CI according to group 
ggcompetingrisks(
  fit = ci_brand, 
  multiple_panels = FALSE, #force all graphs to be plotted in a single panel 
  xlab = "Months", 
  ylab = "Cumulative incidence of event", 
  title = "Peritonitis", 
  ylim = c(0,1)
)


```


# Abstract 

# Introduction 

Prior studies have shown that certain end-stage kidney failure (ESKF) patients who received peritoneal dialysis (PD) were at a higher risk of peritonitis [@ongRiskPeritonealDialysisRelated2017a]. On average, the rate of peritonitis among PD patients in Malaysia was 0.27 episode per patient-year in a 2009 national PD patient cohort. Studies that examined specific PD products produced different peritonitis rates. A recent multicentre randomised trial of Fresenius Medical Care PD products showed a higher peritonitis rate of 0.41 episode per patient-year [@makClinicalEffectivenessMalaysianmanufactured2021a]. Peritonitis rates produced in similar comparison studies were inconsistent, ranging from 0.34 to 1.26 episodes per patient-year [@wongRandomizedMulticenterOpenlabel2006a; @ongRandomizedMulticenterOpenlabel2003a]. 

In a clinical trial setting, it may not be possible to observe every event of peritonitis given the limited duration of follow-up. Some of the patients may not have developed any peritonitis prior to trial completion. Long-term observational studies with survival analysis may be more feasible to uncover the true peritonitis rates in a given population. Yet, time-to-event analyses were rarely undertaken with competing risks taken into consideration, when competing events had the potential to introduce bias in the calculation [@andersenCompetingRisksEpidemiology2012]. 

We aimed to evaluate the hazards and cumulative incidence of first peritonitis among PD patients in Malaysia in the presence of competing events. 



not transferable to other population/country since the distribution of the compting vents differ from the original population - Lau et al 



# Methods 
## Data source 
We considered data from the National Renal Registry (NRR) comprising cohorts of patients who initiated PD in 2014, comparing outcomes in patients with different risk factors. The registry was established in 1992 and collects data from all patients receiving renal replacement therapy in public hospitals.  

## Population 
Incident patients who initated PD in 2014 were included. The sample consisted of 1,149 patients treated in 29 public hospitals. Patients were followed up until the first of the following: peritonitis, transfer to haemodialysis, death, or administrative censoring (November 28, 2018). Our primary interest was on the effects of the **brands** of PD products and the **assistance required to perform PD**. We also included other variables in the multivariate analysis, such as **age**, **diabetes**, **hypertension**, **race**, **ESKF duration**, and **PD duration**. We stratified our analysis based on **treatment centre**. 

## Definition of outcomes 
Peritonitis was defined by the 2016 International Society for Peritoneal Dialysis guideline and recommendation [@liISPDPeritonitisRecommendations2016a]. We counted recurrent and repeat episodes as independent cases, but relapsing peritonitis was not counted separately. 

The competing event was **technique failure** defined as a transfer to haemodialysis for more than 30 days. Technique failure was a frequent complication of PD that occluded the occurrence of peritonitis. We did not include other potential competing events such as kidney transplants or partial recovery of kidney functions because of their low rates of occurrence. 

## Cox proportional hazard 

## Competing risk analysis 

## Goodness of fit tests 
The proportionality hazard (PH) assumption of the CSH models was tested with the cox.zph function provided by the survival package. It tested the proportionality of all covariates in the model using scaled Schoenfeld residuals. 

We attempted to check the PH assumption for the SH models by plotting the Schoenfeld-type residuals against time failure for each of the covariates. This was done through the crr function in the cmprsk package. 
 
## Softwares used 

# Results 
## Cohort description 
There were 1,149 patients who met the study eligibility criteria and included in the analysis. The basic demographic information of the cohort was shown in Table \@ref(tab:tab1). The mean age of the cohort was 58.5 years but covered a wide age range (standard deviation of 14.5 years). The gender and racial composition of the cohort closely resembled the national demographic distribution. Diabetes (56.3%) and hypertension (20.0%) made up the most common primary renal disease. At baseline, 63% of the patients used Baxter PD products, while 36.6% of them used Fresenius PD products. Only 0.4% of patients were using Lucenxia's PD product in 2014. The majority of the cohort (83.8%) was put on continuous ambulatory PD (CAPD). The remaining 5.0% was put on daytime ambulatory PD (DAPD) and 11.1% (**numbers dont add up**) were on either automated PD (APD), continuous cycling PD (CCPD) or nocturnal intermittent PD (NIPD). 

```{r tab1,eval=T, echo=F, cache=F, results=F, warning=F, message=F}
tab1
```

## Goodness of fit (Proportionlity of hazard assumption)
The proportionality assumption of the CSH of the covariates were checked by using scaled Schoenfeld residuals. The PH assumption of the CSH of **peritonitis** was met for **Race** (p=0.93), **Age** (p=0.42), **Assistance required to perform PD** (p=0.61), **diabetes** (p=0.84), and **brands** (p=0.46). Similarly, the PH assumption of the CSH of **technique failure** was met for **Race** (p=0.93), **Age** (p=0.37), **Assistance required to perform PD** (p=0.99), **diabetes** (p=0.42), and **brands** (p=1.00). 



## Crude risks 

(contrast dash line and solid lines - KM vs CI competing risks)

The median time to first peritonitis produced by the KM analysis was 37.1 months. When the cumulative incidence was calculated, the probability of experiencing first peritonitis within the first year was 22.7%. By the end of the follow-up period (*t*=60 months), 53.6% of the patients had experienced a peritonitis episode. 

```{r KM, eval=T, echo=F, cache=F, results=F, warning=F, message=F}
library(survival)
library(magrittr)



```

## Cause-specific hazard of peritonitis 

Cause-specific regression was used to analyse the instanteneous rate of peritonitis in patients who were event-free (had not experience any peritonitis or competing events). The median follow-up duration was XXXX. During this period, 469 patients (40.8%) experience first peritonitis. Univariate analysis indicated that **race**, **age group**, **PD assistance**, **diabetes as the primary renal disease**, **treatment centre (states)** and **PD company** were significant covariates but subsequent multivariate Cox proportional regression showed that only **age group (80-89 years)** (HR: 2.07; 95% CI: 1.07-4.00), **partial need for PD assistance** (HR: 1.12; 95% CI: 1.04-1.76), **diabetes as the primary renal disease** (HR: 1.29; 95% CI: 1.04-1.60), **treatment centre in Melaka** (HR: 0.51; 95% CI: 0.27-0.96), **treatment centre in Terengganu** (HR: 0.57; 95% CI 0.36-0.91), and **Fresenius** products (HR: 1.66; 95% CI: 1.37-2.00) had a significant influence on the instanteneous rate of peritonitis in patients who were still event-free (see Table 1 -- reference the table here)

## Subdistribution hazard of peritonitis 

Subdistribution hazard model gave the probabilities of peritonitis in patients who had not experienced any peritonitis or had had the competing risk events prior to a designated time *t*. Our model suggested a similar set of covariates had affected the peritonitis probability. **Age group (80-89 years)** (HR: 2.16; 95% CI: 1.10-4.27), **partial need for PD assistance** (HR: 1.35; 95% CI: 1.03-1.76), **diabetes as the primary renal disease** (HR: 1.26; 95% CI: 1.01-1.56), and **Fresenius** products (HR: 1.68; 95% CI: 1.39-2.04). Treatment centr was another ........













Literature review 

1. Chen et al 2019 

- clarify the risk factors of technique failure and outcomes (including PD-related peritonitis and mortality)
- multivariate analysis model (with subdistribution hazard)
- DM was a risk factor for peritonitis
- Female & higher serum albumin were associated with lower risks of technique failure 
- Gram-negative & polymicrobial infection increased the technique failure rate
- Female associated with overall mortality 
- Higher weekly urea clearance (Kt/V) and weekly creatinine clearance (WCCr) associated with a lower risk of mortality 

2. Evans et al 2010 
- Must cite paper 

3. Kim et al 2017 
- To evaluate the influence of education on the development of peritonitis, technique failure, and overall mortality 
- Cox PH model with adjustment (enter method) used to examine the independent risk factors related to all-cause mortality and time to first peritonitis. 
- Fine and Gray's model used to examine the difference in technique failure rates (between education levels?)

4. Ong et al 2016 
- Risk factors of PD-related in Malaysia multi-racial Asian population 
- Risk factors included (increase risk): severe obesity, hypoalbuminemia, *Staph. aureus* nasal carriage, FMC system, 
- Risk faactors (lower risk) automated PD vs standard PD, centre with patient-staff ratio 15-29.9 or >=30, prevalent patients, exit site care with antibiotics 

# Method

*Study design* 

*Setting* 

*Participants* 

*Variables* 

*Data source* 

*Bias* 

*Study size* 

*Quantitative variables* 

*Kaplan-Meier survival analysis* 
The standard Kaplan-Meier approach was used. The survival probability by time *t* referred to the risk of failure from peritonitis while all other causes of failure were absent. The cumulative incidence of peritonitis was calculated by the formula $CI=1-KM$

*Competing risk survival analysis* 
The event of interest was peritonitis, and competing risk events were death, transfer to HD, renal transplant, and partial recovery of kidney function prior to the first peritonitis. The CI functions for individual competing risk event were calculated using **????** approach. 

*Regression* 
Data from 1149 patients were included in the competing risk regression analysis. The aim was to identify risk factors (????)


*Software* 
The open-source R (version 3.6.0) was used. We used the packages *cmprsk* (version 2.2.9), *survival* (version 2.44.1.1), and *survminer* (version 0.4.5) for our analysis. 


# Results 

*Patient characteristcs* 
Patient characteristics are summarised in Table 1. 


















##### PRESENTATION TO DR ONG LM ##### 

Overall aim: 
1. Comprehensive analysis of peritonitis risk among PD patients in Malaysia

Specifically to answer the following question: 

1. How long it takes from first PD to developing first peritonitis? 
2. How does this interval fluctuates according to different risk factors? 
3. How does the interval  to first peritonitis and risk change when competing risks (i.e. transfer to HD, death, transplanted, partial recover of kidney functions) are considered?
4. What is the relationship between suffering peritonitis with a terminal event (defined as transfer to HD, and death)

# Kaplan-Meier and Log-rank test 

source: http://www.sthda.com/english/wiki/survival-analysis-basics#fit-complex-survival-curves 

The Kaplan-Meier (KM) survival estimate is a non-parametric approach to estimate the survival probability. The survival function (i.e. the mathematical equation that calculates the survival probability) is defined as: $$S(t_i)=S(t_{i-1})(1-d_i/n_i)$$

where, 

- S(t~i~) is the survival probability at time t~i~
- d~i~ is th number of events at time t~i~
- n~i~ is the number of patients alive just before time t~i~ 

The KM survival curve and the logrank test are *univariate analysis* which are limited to one factor when describing the survival probability. This factor must be a categorical variable. 

KM survival analysis will ignore the impact from all other factors (except the one included in the model). Thus, KM survival analysis might be biased in its estimates. \textcolor{red}{need to find literature that proved KM is biased in its estimates}

## KM survival curves by patient gender 

Based on the data extracted from the NRR (2014-2018, PD-only), the median peritonitis-free survival by gender and the survival curves are shown below: 

```{r, eval=T, echo=F, cache=T, warning=F, message=F, results=T}

print(fit.kaplan.sex)
KM_sex

```

There was no significant difference between both gender (p=0.95) in terms of the duration to first peritonitis (peritonitis-free interval). 

The complement of the KM estimate of the survival function (1-S(t)) provides an estimat of the *cumulative incidence* of events over time. Based on our analysis, $S(t_{60m})=0.473$. 

```{r, eval=T, echo=F, cache=T, warning=F, message=F, results=T}

summary(fit.kaplan, times=60)
```

The cumulative incidence of peritonitis over 60 months was 0.527. 

An interesting observation is the discrepancy between the risk table and the KM survival curve. The risk table suggests that the number of patient at risk of peritonitis decreased substantially but the survival curve remained plateau at approximately 0.5. A high density in the censor plot implied that a large number of our subjects did not develop peritonitis before they were censored. 



# Cox regression analysis 

Source: http://www.sthda.com/english/wiki/cox-proportional-hazards-model#:~:text=The%20Cox%20model%20can%20be,term%20that%20varies%20with%20time. 

We know that the risk of peritonitis is affected by multiple clinical and socio-economical factors (need quotes) simultaneously, but KM analysis could not handle *multivariate approach*. 

The Cox proportional hazard (PH) model is appropriate to evaluate multiple factors that influence survival. The Cox PH model produces *hazard rate*, which is the rate of an event of interest (like peritonitis) happening at a particular time point. This *hazard rate* can be expressed through the *hazard function*, as below: $$h(t)=h_0(t)*exp(b_1x_1 + b_2x_2 + ... + b_px_p)$$
where, 

- *t* is the survival time 
- h(t) is the hazard function
- x~p~ is the set of p covariates
- b~p~ is the coefficient that measures the effect size of a covariate
- h~0~ is the baseline hazard. This is the valuem of hazard if all covariates x~i~ are equal to zero (i.e. exp(0)=1)

The hazard function can be simplified as $$h(t)=h_0(t)*e^(\sum_{i=1}^{n} bx)$$

The Cox model can be written as a **multiple linear regression** of the **logarithm** of the hazard on variables x~i~, with the baseline hazard being an 'intercept' term that varies with time.

## Univariate Cox regression 

We begin by examining the influence of individual hazard of peritonitis with *univariate Cox regression* analysis. 

The variables included were: age, gender, race, require assistant to perform PD, primary renal diseases, and comorbidities 
```{r, eval=T, echo=F, cache=T, warning=F, message=F, results=T}

res <- t(as.data.frame(univ_results, check.names = FALSE))
as.data.frame(res)

```

The inclusion criteria for the subsequent *multivariate Cox regression* was a p-value of <0.1 (instead of 0.05). *Univariate Cox regression* suggested that Age, comorbidity (cancer and CCF) and primary renal disease from diabetes had significant influence over the hazard rate of peritonitis. These variables were included in the following *multivariate Cox regression* analysis 

## Multivariate Cox regression 
```{r, eval=T, echo=F, cache=T, warning=F, message=F, results=T}

summary(multiv_cox)
```

The *multivariate Cox regression* showed that **race, age, diabetes as the primary renal disease**, and *cancer as comorbidity* were significant hazards for peritonitis. Specifically, *bumiputera Sabah* were at a higher hazard to experience peritonitis, with a hazard ratio (compared to *Malay* as baseline) of 2.46 (95% CI: 1.452 - 4.163). Having dibetes as the primary renal disease and cancer as a comorbidity both caused a higher hazard of experiencing peritonitis. The respective hazard ratio was 1.33 (95% CI: 1.074 - 1.651) an 3.71 (95% CI: 1.184 - 11.622). Older age also caused a higher hazard, with a hazard ratio of 1.01 (95% CI 1.003 - 1.019).   

The survival curve was shown below: (\textcolor{red}{probably don't show the curve})
```{r, eval=T, echo=F, cache=T, warning=F, message=F, results=T}

cox_plot
```

The survival plot indicated that the patient cohort did not reach median survival (i.e. survival probabilit of 0.5) by the end of the 5-years follow-up. This is in contrast to the KM survival plot

# Competing risk analysis 

One of the issue we identified earlier was the large amount of censored cases (see Part 1: Kaplan Meier survival probability). Both the KM survival analysis and Cox PH regression model treat any other causes of "failure" - any other clinical incidents that precluded the occurence of peritonitis, such as transfer to HD, death, transplanted, or partial recovery of kidney function, as censored cases. 

Obviously, these patients were not lost to follow-up. They experience events that stopped them from developing peritonitis. So censoring these patients at the occurence of competing risk event have violated several assumptions for survival analysis: the censored cases were independent and noninformative.

Using KM estimates for incidence funcion in the presence of competing risks typically would produce upward biases in the estimation of the incidence function (quote Austin 2016). To better estimates the incidence of peritonitis while taking into consideration of competing risk, the *Cumulative Incidence Function (CIF)* should be used. It is distinct from $1-S(t)$, and can be defined for the *k*th cause as $$CIF_k(t)=Pr(T\le{t},D=k)$$

Where,

- D is a variable denoting the type of event that occured

CIF~k~(t) denotes the probability of experiencing the *k*th event before time *t* and before the occurence of a different type of event. Different from the KM estimates, the sum of CIF estimates of the incidence of each individual outcomes will equal the CIF estimates of the incidence of the composite outcome consisting all of the competing events. (quote Austin 2016) 


## Hazard function regression 

The hazard function (which is a function of time) describes the instantaneous rate of occurence of the event of interest (peritonitis) in subjects who are *still at risk* of the event. The Cox PH regression model relates the hazard function to a set of covariates but it does not relate the covariates directly to the survival times themselves. 

The hazard ratio describes the relative change in the hazard function in response to one-unit change in the covariate. The *regression coefficient* of the Cox model (without the exponential) describe the relative effect of the covariates on the hazard. In the absence of competing risks, the following relationship holds: $$S(t)=S_0(t)^{e(x,\beta)}$$

Thus, the relative effect (i.e. *regressioin coefficient*) of a given covariate on the **hazard of the outcome** is equal to the relative effect of that covariate on the **logarithm of the survival function**. Thus, any inferences made about the effect of a covariate on the hazard function are equivalent about the effect on prognosis or survival. This direct correspondence between **hazard function** and **incidence** allows conclusions about a risk factor (or variable) increases the risk of an event without specifying whether risk denoted the hazard of an event (the **rate of occurence** of people who are still at risk) or the incidence of the event (the **probability** of the occurence of the event). 

In competing risk analysis, 2 different types of hazard functions are of interest: 

- *cause-specific* hazard function 
- *subdistribution* hazard function 

The *subdistribution* hazard model is also known as the *CIF regression model*, which describes the link between the subdistribution hazard and the effect on the incidence of an event. This model allows the direct prediction of the cumulative incidence for an event of interest using the usual relationship between the hazard and the incidence function. The subdistribution hazard model also allows the estimation of the effect of covariates on the cumulative incidence function for the event of interest. 

